<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Personal Finance Assistant</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ðŸ’° AI Personal Finance Assistant</h1>
            <p class="subtitle">Smart financial management for micro-businesses</p>
        </header>
        <main class="chat-wrapper">
            <div id="root"></div>
            <div id="loading" style="display:none; text-align:center; padding:20px;">
                <p>Loading chat assistant...</p>
            </div>
        </main>
    </div>

    <script>
        // Get auth token from backend and initialize chat
        async function initializeChat() {
            try {
                // Show loading state
                document.getElementById('loading').style.display = 'block';

                // Fetch token from backend
                const tokenResponse = await fetch('/api/auth/wxo-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!tokenResponse.ok) {
                    throw new Error(`Token request failed: ${tokenResponse.status}`);
                }

                const { token } = await tokenResponse.json();

                // Store token in localStorage
                localStorage.setItem('wxo_auth_token', token);
                localStorage.setItem('wxo_token_timestamp', Date.now());

                // Hide loading
                document.getElementById('loading').style.display = 'none';

                // Configure Watson Orchestrate with token
                window.wxOConfiguration = {
                    orchestrationID: "20251122-1800-1311-1064-7f0d4c11a37b_20251122-1800-1929-204d-034c623802de",
                    hostURL: "https://dl.watson-orchestrate.ibm.com",
                    rootElementID: "root",
                    chatOptions: {
                        agentId: "886acbbe-c2ec-41ac-adb5-7da189613256",
                        agentEnvironmentId: "1204da90-9213-423d-9650-53edbdb8d370"
                    }
                };

                // Load Watson Orchestrate script
                loadWatsonOrchestrate();

            } catch (error) {
                console.error('Failed to initialize chat:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">Error: ${error.message}</p>
                    <p>Please check your configuration and try refreshing the page.</p>
                `;
            }
        }

        // Load Watson Orchestrate chat widget
        function loadWatsonOrchestrate() {
            const script = document.createElement('script');
            script.src = `${window.wxOConfiguration.hostURL}/wxochat/wxoLoader.js?embed=true`;

            script.addEventListener('load', function () {
                // Set up token refresh listener
                document.addEventListener('wxoAuthTokenNeeded', async function(event) {
                    console.log('Auth token refresh needed');
                    const newToken = await getRefreshedToken();
                    if (event.detail) {
                        event.detail.authToken = newToken;
                    }
                });

                // Initialize the chat widget
                if (window.wxoLoader) {
                    wxoLoader.init();
                }
            });

            script.addEventListener('error', function() {
                console.error('Failed to load Watson Orchestrate script');
                document.getElementById('root').innerHTML = '<p class="error-message">Failed to load chat widget.</p>';
            });

            document.head.appendChild(script);
        }

        // Get stored auth token
        function getAuthToken() {
            return localStorage.getItem('wxo_auth_token') || null;
        }

        // Refresh token if needed
        async function getRefreshedToken() {
            try {
                const response = await fetch('/api/auth/wxo-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const { token } = await response.json();
                    localStorage.setItem('wxo_auth_token', token);
                    return token;
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
            }
            return null;
        }

        // Initialize chat when page loads
        window.addEventListener('load', initializeChat);
    </script>
</body>
</html>
